<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title data-i18n="pageTitle">Tijuana River Valley Sewage Crisis Environmental Dashboard</title>
  <link rel="stylesheet" href="./css/index.css">
  <link rel="stylesheet" href="./css/iconography.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

  <!-- jquery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>

    /* this will be the description for a beach about it's sampling */
    .beach-description  {
      display: none;

    }
    /* this will be the description for a beach about it's closure or advisory */
    .beach-message  {
      display: none;

    }
    /* this border for the table */
    table.odor-table {
      border-collapse: collapse;
    }
    table.odor-table td,  table.odor-table th {
      border: 1px solid black;
    }

  </style>
  <!-- Multilanguage support -->
  <script src="https://unpkg.com/i18next/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-http-backend/i18nextHttpBackend.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="./js/language.js" defer></script>

  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.js"></script>

  <script src="js/app.js" defer></script>

  <!--  <script type="module" src="js/fsmap.js"></script>-->
<!--  <script type="module">-->
<!--    const fs = "fsq3CYDP77ybwoo1KtkJigGRj6g0uYyhWVw25jM+zN6ovbI="-->
<!--    const mapuid = '6ce3b305-7e09-44b3-8725-34dcf59bb56d'-->
<!--    //   import {createMap} from 'https://corsproxy.io/?key=3d648870&url=https://cdn.jsdelivr.net/npm/@foursquare/map-sdk@latest/dist/index.js';-->
<!--    import {createMap} from 'https://cdn.jsdelivr.net/npm/@foursquare/map-sdk@latest/dist/index.js';-->

<!--    const map = await createMap({-->
<!--      apiKey: fs,-->
<!--      container: document.getElementById('map-container'),-->
<!--      // this loads a published map-->
<!--      // (original url: https://studio.foursquare.com/public/806b95d0-36bb-402c-b16c-24e54af4a761)-->
<!--      initialState: {-->
<!--        publishedMapId: mapuid-->
<!--      },-->
<!--      uiConfig: {-->
<!--        sidePanel: {-->
<!--          view: 'hidden',-->
<!--          isAddLayerVisible: false,-->
<!--        },-->
<!--        sideNav: {-->
<!--          isVisible: false-->
<!--        },-->
<!--        mapControls: {-->
<!--          isVisible: false,-->
<!--          zoom: {-->
<!--            isVisible: false-->
<!--          }-->
<!--        }-->
<!--      },-->
<!--      mapState: {-->
<!--        globe: {-->
<!--          enabled: false,-->
<!--        }-->
<!--      }-->

<!--    });-->
<!--  &lt;!&ndash;  map.setMapControlVisibility(&ndash;&gt;-->
  <!--    {legend:false,toggle_3d:false,split_map:false, map_draw:false}-->
  <!--  )-->
  <!--  // cannot override style sheet. #shadow-root is closed.-->
  <!--  // var sheet = new CSSStyleSheet-->
  <!--  // sheet.replaceSync( `.unfolded-root + div + div  {visibility: collapse;}`)-->
  <!--  // map.shadowRoot.adoptedStyleSheets.push(sheet) // You want to add to stylesheets list-->
  <!--  globalThis.map = map-->

  <!--  setTimeout(() => { // Wait a short time for the map to fully render-->
  <!--    try {-->
  <!--      const mapContainerDiv = document.getElementById('map-container').querySelector('div'); // Get the inner div-->
  <!--      if (mapContainerDiv) {-->
  <!--        // Try to query for the button - this is VERY DOM-structure dependent-->
  <!--        const hackyButtonTarget = mapContainerDiv.querySelector('.map-control-button.button'); // Adjust selector if needed-->
  <!--        if (hackyButtonTarget) {-->
  <!--          hackyButtonTarget.style.display = 'none !important'; // Try to hide it-->
  <!--          console.warn("HACKY BUTTON HIDING ATTEMPTED - VERY FRAGILE!");-->
  <!--        } else {-->
  <!--          console.warn("HACKY BUTTON TARGET NOT FOUND - MAYBE SELECTOR IS WRONG?");-->
  <!--        }-->
  <!--      } else {-->
  <!--        console.warn("HACKY MAP CONTAINER INNER DIV NOT FOUND!");-->
  <!--      }-->
  <!--    } catch (error) {-->
  <!--      console.error("HACKY BUTTON HIDING FAILED:", error);-->
  <!--    }-->
  <!--  }, 10000); // 10 second delay - adjust if needed-->

  <!--</script>-->


  <script>
    //     <button onclick="toggleLayer(this, 'Beach Closures')">Beach Closures</button>

    const layerGroupInfo = [
      {label: 'Hâ‚‚S Levels', id: 'h2s_group' , layers: ['h2s','h2s-name', 'h2s-value']}, // health layer for now
      {label: 'Odor Complaints', id: 'odor_group' , layers: ['clusters','cluster-count','unclustered-point']}, // odor
      {label: 'Wastewater Spills', id: 'spill_group' , layers: ['spills']}, // water
      {label: 'Beach Status', id: 'beach_group' , layers: ['beaches']}, // observations
      {label: 'River Basin', id: 'water_group' , layers: []},

    ]


    // Toggle Sidebar Function
    const layerInfo = [
      {label: 'Hâ‚‚S Levels', id: 'g0nrfjd'}, // health layer for now
      {label: 'Smell Complaints', id: '49rpvvq'}, // odor
      {label: 'Wastewater Spills', id: 'hg4pxs'}, // water
      {label: 'Beach Status', id: 'dpoomlg'}, // observations
      {label: 'River Basin', id: '6n6ymt9'},

    ]

    // Toggle Expand Function for Cards
    function toggleExpand(ev) {
      ev.stopPropagation();
      let section = ev.target;
      while (!section.classList.contains("expandable")) {
        section = section.parentElement;
      }
      section.classList.toggle("expanded");
    }

    function setGroupVisibility(map, layerInfo, visibility) {
      layerInfo.layers.forEach(layerId => {
        // Ensure the layer exists before attempting to change it
        if (map.getLayer(layerId)) {
          map.setLayoutProperty(layerId, 'visibility', visibility);
        }
      });
    }
    // Toggle Layer Function for Top Pills
    function toggleLayer(button, layer) {
      if (undefined !== map) {


        let visibility = 'none'
        if ( button.classList.toggle("active") ) {
          console.log("toggled active: true");
          visibility = 'visible'
        } else {
          console.log("toggled active: false");
        }
        button.querySelector("i").classList.toggle("bi-check-square-fill");
        button.querySelector("i").classList.toggle("bi-x-square");
        console.log("Toggled layer group:", layer);
        const layerinfo = layerGroupInfo.find((l) => l.label === layer)
        console.log("Toggled layer group:" + layer + " layerid:", layerinfo);
        console.log("Toggled layer: groups", layerinfo.layers);
        setGroupVisibility(map,layerinfo,visibility)
      } else {
        console.log("toggleLayer: no map object: ", layer);
      }

    }
    // function toggleLayer(button, layer) {
    //   if (undefined !== map) {
    //
    //
    //     button.classList.toggle("active");
    //     button.querySelector("i").classList.toggle("bi-check-square-fill");
    //     button.querySelector("i").classList.toggle("bi-x-square");
    //     console.log("Toggled layer:", layer);
    //     const layerid = layerInfo.find((l) => l.label == layer)
    //     console.log("Toggled layer:" + layer + " layerid:", layerid);
    //     const groups = map.getLayerGroups();
    //     console.log("Toggled layer: groups", groups);
    //     let targetLayer = groups.find((g) => g.id == layerid.id)
    //     console.log("Target layer:", targetLayer);
    //     if (targetLayer.isVisible) {
    //       targetLayer.isVisible = false;
    //
    //     } else {
    //       targetLayer.isVisible = true;
    //
    //     }
    //     map.updateLayerGroup(targetLayer.id, targetLayer)
    //   } else {
    //     console.log("toggleLayer: no map object: ", layer);
    //   }
    //
    // }

    // When a card is clicked, select the corresponding pill
    function selectCard(layer) {
      var buttons = document.querySelectorAll("#top-bar button");
      buttons.forEach(function (btn) {
        btn.classList.remove("active");
        if (btn.textContent.trim().toLowerCase() === layer.toLowerCase()) {
          btn.classList.add("active");
        }
      });
      console.log("Selected card for layer:", layer);
    }

    // Dummy play function for time widget
    function playTime(layer, sliderElem) {
      console.log("Playing time for " + layer + ", current value: " + sliderElem.value);
      // Implement fsmap updates based on time here.
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".card-header").forEach(function (card) {
        card.addEventListener('click', function (e) {
          toggleExpand(e);
        });
      });
    });
  </script>

  <script defer src="./js/sidebar.js"></script>
</head>
<body class="light">
<div id="container">
  <!-- Map Container with Kepler fsmap configured for San Ysidro (approx 50-mile radius) -->
  <div id="map-container"></div>
<!--  <div id="hidepanel">-->
<!--  </div>-->
  <!-- Top Pill Container -->
  <div id="top-bar-container">
    <div id="top-bar">
      <button class="active" onclick="toggleLayer(this, 'Beach Status')">
        <i class="bi bi-check-square-fill"></i>
        <div>
          <span data-i18n="topbar.beaches">Beach Status</span>
          <br>
          <span class="trend-flat sublabel" data-i18n="topbar.currentData">current data</span>
        </div>
      </button>
      <button class="active" onclick="toggleLayer(this, 'Hâ‚‚S Levels')">
        <i class="bi bi-check-square-fill"></i>
        <div>
          <span data-i18n="topbar.h2sLevels">Hâ‚‚S Levels</span>
          <br>
          <span class="trend-flat sublabel" data-i18n="topbar.currentData">current data</span>
        </div>
      </button>
      <button class="active" onclick="toggleLayer(this, 'Odor Complaints')">
        <i class="bi bi-check-square-fill"></i>
        <div>
          <span data-i18n="topbar.odorComplaints">Smell Complaints</span>
          <br>
          <span class="trend-flat sublabel" data-i18n="topbar.prev3days">previous 3 days</span>
        </div>
      </button>
      <button class="active" onclick="toggleLayer(this, 'Wastewater Spills')">
        <i class="bi bi-check-square-fill"></i>
        <div>
          <span data-i18n="topbar.wastewaterSpills">Wastewater Spills</span>
          <br>
          <span class="trend-flat sublabel" data-i18n="topbar.prev30days">previous 30 days</span>
        </div>
      </button>
      <button onclick="toggleLayer(this, 'River Basin')">
        <i class="bi bi-x-square"></i>
        <span data-i18n="topbar.riverBasin">River Basin</span>
      </button>
    </div>
  </div>

  <!-- Sidebar / Drawer -->
  <div id="sidebar-container">
    <!-- Floating button to open/close in desktop -->
    <button id="sidebar-btn" class="open" onclick="toggleSidebar()"><i class="bi bi-chevron-left"></i></button>

    <div id="sidebar" class="open">
      <div id="sidebar-handle"><div class="grip"></div></div>
      <div id="sidebar-header">
        <div><a href="https://www.sandiegocounty.gov/" target="_blank"><img src="img/logoCOSD.png"></a></div>
        <div id="sidebar-title"><span data-i18n="sidebar.title">Tijuana River Valley Sewage Crisis Environmental Dashboard</span></div>
        <div><a href="https://www.sandiegocounty.gov/" target="_blank"><img src="img/ResilientLogo.png"></a></div>
      </div>

      <div id="language-selector-container">
        <select id="language-selector" onchange="setLanguage(this.value)">
          <option value="en">ðŸ‡ºðŸ‡¸ English</option>
          <option value="es">ðŸ‡²ðŸ‡½ EspaÃ±ol</option>
          <option value="tl">ðŸ‡µðŸ‡­ Tagalog</option>
          <option value="vi">ðŸ‡»ðŸ‡³ Tiáº¿ng Viá»‡t</option>
          <option value="ar">ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="zh">ðŸ‡¨ðŸ‡³ ä¸­æ–‡</option>
          <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
          <option value="pt">ðŸ‡§ðŸ‡· PortuguÃªs</option>
        </select>
      </div>

      <div id="sidebar-body">
        <div class="sidebar-card-separator"><span><h2 data-i18n="sidebar.sections.ongoing">Ongoing Events</h2></span></div>

        <!-- What We Know -->
        <div class="card shadow expandable" onclick="selectCard('What We Know')">
          <div class="card-header always-expand">
            <i class="bi bi-info-circle"></i>
            <h3 class="card-title" data-i18n="sidebar.cards.whatWeKnow.title">What We Know</h3>
            <button class="expand-btn"><i class="bi bi-chevron-down"></i></button>
          </div>


          <p data-i18n="sidebar.cards.whatWeKnow.p1">
            A combination of several factors has led to the overflow of sewage, causing runoff water and contamination to go into the ocean on both the Mexico and U.S. sides of the border.
          </p>
          <p data-i18n="sidebar.cards.whatWeKnow.p2">
            There are multi-agency efforts to address air and water quality issues in the Tijuana River Valley that are impacting San Diego area communities.
          </p>
          <p data-i18n="sidebar.cards.whatWeKnow.p3">
            This dashboard and mapping tool provide information from multiple sources about the air and beach/river water quality in San Diego related to this issue.
          </p>

          <div class="card-footer">
            <span></span>
            <a></a>
          </div>
        </div>

        <!-- What You Can Do -->
        <div id="what-you-can-do-card" class="card text-card shadow expandable">
          <div class="card-header always-expand">
            <i class="bi bi-person"></i>
            <h3 class="card-title" data-i18n="sidebar.cards.whatYouCanDo.title">What You Can Do</h3>
            <button class="expand-btn"><i class="bi bi-chevron-down"></i></button>
          </div>

          <div>
            <p data-i18n="sidebar.cards.whatYouCanDo.reportOdor">
              Report odor complaints to the San Diego County Air Pollution Control District by:
            </p>
            <ul>
              <li data-i18n="sidebar.cards.whatYouCanDo.reportOptions.app">Mobile app</li>
              <li data-i18n="sidebar.cards.whatYouCanDo.reportOptions.phone">Phone at (858) 586-2650,</li>
              <li data-i18n="sidebar.cards.whatYouCanDo.reportOptions.email" data-i18n-html="true">Email to <a href="mailto:apcdcomp@sdapcd.org" >apcdcomp@sdapcd.org</a>, or</li>
              <li><a href="http://www.sdapcd.org/content/sdapcd/compliance/air-quality-complaints.html" target="_blank" data-i18n="sidebar.cards.whatYouCanDo.reportOptions.online">Visit online</a></li>
            </ul>
          </div>

          <p data-i18n="sidebar.cards.whatYouCanDo.reportInfoNeeded">
            When filing a report, the following information will assist us in investigating your concern:
          </p>
          <ul>
            <li data-i18n="sidebar.cards.whatYouCanDo.infoItems.name">Your name, address, and telephone number</li>
            <li data-i18n="sidebar.cards.whatYouCanDo.infoItems.time">The time and date the air quality concern occurred and whether it is still continuing</li>
            <li data-i18n="sidebar.cards.whatYouCanDo.infoItems.nature">The nature of the air quality concern (smoke, dust, odor, or other)</li>
            <li data-i18n="sidebar.cards.whatYouCanDo.infoItems.source">The name and address of the alleged source and the type of operation causing it (if known)</li>
          </ul>

          <p>
            <span data-i18n="sidebar.cards.whatYouCanDo.h2sLink.label">Recommendations based on current Hydrogen Sulfide levels can be found here:</span>
            <a href="https://www.sdapcd.org/content/sdapcd/about/tj-river-valley/tjrv-air-quality-monitoring.html" target="_blank" data-i18n="sidebar.cards.whatYouCanDo.h2sLink.link.text">Air Quality Monitoring</a>
          </p>

          <p data-i18n="sidebar.cards.whatYouCanDo.reduceAirExposure">
            You can reduce your exposure to poor quality air or strong odors by limiting outdoor activity, keeping windows and doors closed, and airing out your home or business when odors are not present.
            If available, use air conditioning or portable indoor air purifiers.
            Look into whether filters need to be replaced.
            Use certified HEPA filters with activated charcoal.
            If possible, run your air conditioner at your business for 1-2 hours before opening.
          </p>

          <br>
          <p data-i18n="sidebar.cards.whatYouCanDo.beachSafety">
            Don't make direct physical contact with beach water at any closed beach.
            This is especially important after heavy rain.
            Stay away from areas with visible sewage spills.
            Stay out of floodwater.
            Do not swim, go into, or swallow contaminated beach water sources.
          </p>

          <div class="card-footer">
            <span data-i18n="sidebar.cards.whatYouCanDo.footer.text"></span>
            <a data-i18n="sidebar.cards.whatYouCanDo.footer.link.text"></a>
          </div>
        </div>


        <!-- What We Don't Know -->
        <!-- <div class="card text-card shadow expandable">
          <div class="card-header always-expand">
            <i class="bi bi-person-walking"></i>
            <span class="card-question-circle">What We Don't Know</span>
            <button class="expand-btn"><i class="bi bi-chevron-down"></i></button>
          </div>

          <p>For details on the County's response to the sewage crisis and how to protect your health,
            visit our page about <a target="_blank"
              href="https://www.sandiegocounty.gov/content/sdc/hhsa/programs/phs/community_epidemiology/south-region-health-concerns/County-Role.html">
              South Region Health Concerns </a>
            </p>
          <div id="doing-info" class="expandable">
            <div class="text-card">
              <h4> For more details about specific datasets, visit:</h4>
              <ul>
                <li><a target="_blank" href="https://sdbeachinfo.com/">San Diego Beach & Bay Water Quality Program</a></li>
                <li> <a target="_blank" href="https://www.sdapcd.org/">San Diego Air Pollution Control District</a></li>
                <li><a target="_blank" href="https://www.sandiegocounty.gov/content/sdc/hhsa/programs/phs/community_epidemiology/south-region-health-concerns/Local-Data.html">South Region Health Concerns Public Health Data</a>
                </li>
              </ul>
            </div>
          </div>
        </div> -->

        <!-- What Weâ€™re Doing -->
        <div id="what-were-doing-card" class="card text-card shadow expandable">
          <div class="card-header always-expand">
            <i class="icon-action"></i>
            <h3 class="card-title" data-i18n="sidebar.cards.whatWereDoing.title">What We're Doing</h3>
            <button class="expand-btn"><i class="bi bi-chevron-down"></i></button>
          </div>

          <p data-i18n="sidebar.cards.whatWereDoing.p1"></p>

          <p>
            <span data-i18n="sidebar.cards.whatWereDoing.p2">More information about what actions the County is taking to ensure the health and quality of life for South Region residents can be found here:</span>
            <a href="https://www.sandiegocounty.gov/content/sdc/hhsa/programs/phs/community_epidemiology/south-region-health-concerns/County-Role.html" target="_blank" data-i18n="sidebar.cards.whatWereDoing.link.text">What the county is doing</a>
          </p>

          <div class="card-footer">
            <span data-i18n="sidebar.cards.whatWereDoing.footer.text"></span>
            <a data-i18n="sidebar.cards.whatWereDoing.footer.link.text"></a>
          </div>
        </div>

        <!-- Card: Air Quality (with time widget inside expandable section) -->
        <!--    <div class="card shadow expandable expanded" onclick="selectCard('Air Quality')">-->
        <!--      <div class="card-header always-expand">-->
        <!--        <h3 class="card-title">Air Quality</h3>-->
        <!--        <button class="expand-btn">âŒ„</button>-->
        <!--      </div>-->
        <!--      <div class="card-data">-->
        <!--        <span class="indicator moderate"></span>-->
        <!--        <span>AQI: 42</span>-->
        <!--        <span class="trend-up">â–² +3%</span>-->
        <!--      </div>-->
        <!--      <div id="aq-info" class="expandable">-->
        <!--        <p>Urban emissions contribute to moderate air quality. Pollutant levels are rising.</p>-->
        <!--        <a target="_blank" href="#">Check full AQI report</a>-->
        <!--        <div class="time-widget">-->
        <!--          <span class="time-title">Time Range:</span>-->
        <!--          <input type="range" min="2000" max="2025" value="2010" class="time-slider">-->
        <!--          <button class="time-play" onclick="playTime('Air Quality', this.previousElementSibling)">Play</button>-->
        <!--        </div>-->
        <!--      </div>-->
        <!--    </div>-->

        <div class="sidebar-card-separator"><span><h2 data-i18n="sidebar.sections.environmental">Environmental Concerns</h2></span></div>

        <!-- Card: Hydrogen Sulfide Levels (with time widget inside expandable section) -->
        <div id="h2s-card" class="card shadow expandable" onclick="selectCard('Hâ‚‚S Levels')">
          <div class="card-header always-expand">
            <i class="bi bi-wind"></i>
            <h3 class="card-title" data-i18n="sidebar.cards.h2s.title">Hydrogen Sulfide</h3>
            <button class="expand-btn"><i class="bi bi-chevron-down"></i></button>
          </div>

          <p data-i18n="sidebar.cards.h2s.p1">
            Hydrogen sulfide (Hâ‚‚S) is a colorless gas with a characteristic odor of rotten eggs. Hydrogen Sulfide is measured in ppb (parts per billion) - lower is better.
          </p>

          <p>
            <span data-i18n="sidebar.cards.h2s.p2">Longer term monitoring information can be found here:</span>
            <a href="https://app.powerbigov.us/view?r=eyJrIjoiOGMwYzM2ZGYtZGU4Ny00ZGI5LWE2NWMtMmZlOGEzZTYzMDc3IiwidCI6IjQ1NjNhZjEzLWMwMjktNDFiMy1iNzRjLTk2NWU4ZWVjOGY5NiJ9" target="_blank" data-i18n="sidebar.cards.h2s.link.text">Hydrogen Sulfide Monitoring</a>
          </p>

          <div id="h2s_summary" class="card-data">
            <span data-i18n="sidebar.cards.h2s.tableLabel">Recent Measurements</span>
            <table>
              <tbody>
                <tr>
                  <td>
                    <span class="indicator moderate"></span>
                    <span>7.4 ppb</span>
                  </td>
                  <td>
                    <i class="bi bi-clock"></i>
                    <span>12:00 PM</span>
                  </td>
                  <td>
                    <i class="bi bi-geo-alt"></i>
                    <span>NESTOR - BES</span>
                  </td>
                </tr>
                <tr>
                  <td>
                    <span class="indicator moderate"></span>
                    <span>7.4 ppb</span>
                  </td>
                  <td>
                    <i class="bi bi-clock"></i>
                    <span>12:00 PM</span>
                  </td>
                  <td>
                    <i class="bi bi-geo-alt"></i>
                    <span>NESTOR - BES</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="card-footer">
            <span data-i18n="sidebar.cards.h2s.footer.text"></span>
            <a target="_blank" href="https://www.sdapcd.org/" data-i18n="sidebar.cards.h2s.footer.link.text">More Info</a>
          </div>
        </div>

        <!-- Card: Beach Closures (with time widget inside expandable section) -->
        <div id="beach-closures-card" class="card shadow expandable" onclick="selectCard('Beach Closures')">
          <div class="card-header always-expand">
            <i class="bi bi-water"></i>
            <h3 class="card-title" data-i18n="sidebar.cards.beachClosures.title">Beach Closures</h3>
            <button class="expand-btn"><i class="bi bi-chevron-down"></i></button>
          </div>

          <div id="beach-closure-data-overview" class="card-data always-expand">
            <table>
              <tbody>
                <tr>
                  <td>
                    <span class="indicator moderate"></span>
                    <span id="beach-closure-count" data-i18n="sidebar.cards.beachClosures.overview.count">-3 Beaches Closed</span>
                  </td>
                  <td>
                    <i class="bi bi-graph-up-arrow trend-up"></i>
                    <span class="trend-up" data-i18n="sidebar.cards.beachClosures.overview.trend"> +100 from last week</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <p>
            <span data-i18n="sidebar.cards.beachClosures.p1.body">Sewage contamination has led to beach closures. Additional warnings and advisories can be found here:</span>
            <a href="https://www.sdbeachinfo.com/" target="_blank" data-i18n="sidebar.cards.beachClosures.p1.link.text">San Diego Beach & Bay Water Quality Program</a>
          </p>
          <p data-i18n="sidebar.cards.beachClosures.p2">
            The following beaches are currently closed.
          </p>

          <div id="beach-closure-data" class="card-data">
            <span data-i18n="sidebar.cards.beachClosures.tableLabel">Recent Closures</span>
            <table>
              <tbody>
                <tr>
                  <td>
                    <i class="bi bi-geo-alt"></i>
                    <span>Border Field State Park</span>
                  </td>
                  <td>
                    <span class="indicator moderate"></span>
                    <span>closed</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="card-footer">
            <span data-i18n="sidebar.cards.beachClosures.footer.text"></span>
            <a data-i18n="sidebar.cards.beachClosures.footer.link.text"></a>
          </div>
        </div>

        <!-- Card: Public Odor Complaints (with time widget inside expandable section) -->
        <div id="odor-complaints-card" class="card shadow expandable" onclick="selectCard('Odor Complaints')">
          <div class="card-header always-expand">
            <i class="bi bi-exclamation-circle"></i>
            <h3 class="card-title" data-i18n="sidebar.cards.odorComplaints.title">Public Odor Complaints</h3>
            <button class="expand-btn"><i class="bi bi-chevron-down"></i></button>
          </div>

          <div id="odor-complaint-data-overview" class="card-data always-expand">
            <table>
              <tbody>
                <tr>
                  <td>
                    <span class="indicator moderate"></span>
                    <span id="odor-complaint-count"  data-i18n="sidebar.cards.odorComplaints.overview.count">-3 Beaches Closed</span>
                    <br><span class="sublabel trend-flat" data-i18n="sidebar.cards.odorComplaints.overview.sampleDuration">in the last 7 days</span>
                  </td>
                  <td>
                    <i class="bi bi-graph-up-arrow trend-up"></i>
                    <span class="trend-up" data-i18n="sidebar.cards.odorComplaints.trend"> +100 from last week</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <p data-i18n="sidebar.cards.odorComplaints.p1">
            The following are public complaints about odors that have been reported to SDAPCD.
          </p>

          <div id="odor-complaint-data" class="card-data">
            <span data-i18n="sidebar.cards.odorComplaints.tableLabel">Complaints in the last 7 days</span>
            <table>
              <tbody>
                <tr>

                </tr>
              </tbody>
            </table>
          </div>

          <div class="card-footer">
            <span data-i18n="sidebar.cards.odorComplaints.footer.text"></span>
            <a target="_blank" href="https://gis-portal.sandiegocounty.gov/arcgis/apps/dashboards/f1f548c93c1b44eeb289b4daa0bec5df" data-i18n="sidebar.cards.odorComplaints.footer.text">More data</a>
          </div>
        </div>

        <div class="sidebar-card-separator"><span><h2 data-i18n="sidebar.sections.health">Health Concerns</h2></span></div>

        <!-- Gastrointestinal -->
        <!-- <div id="gastrointestinal-card" class="card text-card shadow expandable expanded">
          <div class="card-header always-expand">
            <i class="bi bi-sun"></i>
            <h3 class="card-title">Gastrointestinal</h3>
            <button class="expand-btn"><i class="bi bi-chevron-down"></i></button>
          </div>

          <p>
            Gastrointestinal symptoms are symptoms such as diarrhea and vomiting. Gastrointestinal symptoms emergency department visits in San Diego County and the South Region area has been gradually declining over the past three months with some short-term fluctuations. The South Region area consistently has fewer visits than the San Diego County.
          </p>

          <div class="card-footer">
            <span></span>
            <a target="_blank" href="https://www.sandiegocounty.gov/content/dam/sdc/hhsa/programs/phs/Epidemiology/south-region-gi-illness/Surveillance%20Bulletin%20South%20Region%20Health%20Concerns_03122025.pdf">More info</a>
          </div>
        </div> -->

        <!-- Asthma and COPD -->
        <!-- <div id="asthma-card" class="card text-card shadow expandable expanded">
          <div class="card-header always-expand">
            <i class="bi bi-sun"></i>
            <h3 class="card-title">Asthma and COPD</h3>
            <button class="expand-btn"><i class="bi bi-chevron-down"></i></button>
          </div>

          <p>
            Asthma or chronic obstructive pulmonary disease (COPD) symptoms are symptoms such as reactive airway disease, wheezing, and bronchospasm. Asthma and COPD symptoms emergency department visits in San Diego County and the South Region area showed an increasing trend through mid-February but is currently in a gradual decline. South Region visits are consistently lower than the overall San Diego county visits.
          </p>

          <div class="card-footer">
            <span></span>
            <a target="_blank" href="https://www.sandiegocounty.gov/content/dam/sdc/hhsa/programs/phs/Epidemiology/south-region-gi-illness/Surveillance%20Bulletin%20South%20Region%20Health%20Concerns_03122025.pdf">More info</a>
          </div>
        </div> -->


        <!-- South Region Health Concerns -->
        <div id="health-concerns-card" class="card text-card shadow expandable">
          <div class="card-header always-expand">
            <i class="bi bi-graph-up-arrow"></i>
            <h3 class="card-title" data-i18n="sidebar.cards.healthConcerns.title">South Region Health Concerns</h3>
            <button class="expand-btn"><i class="bi bi-chevron-down"></i></button>
          </div>

          <p>
            <span data-i18n="sidebar.cards.healthConcerns.p1.body">County of San Diego is tracking trends in gastrointestinal and respiratory conditions in the south region. For more information and details, go to the </span>
            <a target="_blank" href="https://www.sandiegocounty.gov/content/sdc/hhsa/programs/phs/community_epidemiology/south-region-health-concerns/Local-Data.html" data-i18n="sidebar.cards.healthConcerns.p1.link.text">South Region Health Concerns page</a>.
          </p>

          <div class="card-footer">
            <span data-i18n="sidebar.cards.healthConcerns.footer.text"></span>
            <a data-i18n="sidebar.cards.odorComplaints.footer.link.text"></a>
          </div>
        </div>

        <!-- <div class="sidebar-card-separator"><span><hr></span></div> -->

        <!-- Text Card: For More Information -->
        <!-- <div id="more-info-card" class="text-card card shadow expandable expanded">
          <div class="card-header always-expand">
            <i class="bi bi-info-circle"></i>
            <h3 class="card-title">For More Information</h3>
            <button class="expand-btn"><i class="bi bi-chevron-down"></i></button>
          </div>

          <p>
            For details on the County's response to the sewage crisis and how to protect your health, visit the <a target="_blank" href="https://www.sandiegocounty.gov/content/sdc/hhsa/programs/phs/community_epidemiology/south-region-health-concerns.html">Visit South Region Health Concerns webpage</a>
          </p>
          <h4>Contact & Feedback </h4>
          <p>
            For questions or to provide feedback, please <a href="mailto:phs.southregionhealth.hhsa@sdcounty.ca.gov">email the Epidemiology Unit</a>
          </p>
          <p>
            For more details about specific datasets, visit:
            <ul>
              <li><a target="_blank" href="https://sdbeachinfo.com/">San Diego Beach & Bay Water Quality Program</a></li>
              <li> <a target="_blank" href="https://www.sdapcd.org/">San Diego Air Pollution Control District</a></li>
              <li><a target="_blank" href="https://www.sandiegocounty.gov/content/sdc/hhsa/programs/phs/community_epidemiology/south-region-health-concerns/Local-Data.html">South Region Health Concerns Public Health Data</a>
              </li>
            </ul>
          </p>

        </div> -->

      </div> <!-- End of Sidebar Body -->
    </div> <!-- End of Sidebar -->
  </div> <!-- End of Sidebar Container -->
  <div id="map-disclaimers">
    <p data-i18n="mapDisclaimers.p1">
      Markers on map are not meant to show the area of impact, but rather the location of the data source.
    </p>
  </div>
</div>
<script src="js/mbmap.js"></script>

<script>
  const resilientUrlBase = 'https://oss.resilientservice.mooo.com/resilentpublic/'
  function parseCustomDate(dateStr) {
    // Split the string into parts: [year, day, month]
    let [year,  month, day] = dateStr.split('-').map(Number);
    // Note: in JavaScript, months are 0-indexed (0 = January)
    return new Date(year, month - 1, day);
  }


  /***** Hydrogen Sulfide Data *****/
  fetch(`${resilientUrlBase}tijuana/sd_apcd_air/output/hs2_lastday.records.json`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.statusText);
      }
      return response.json();
    })
    .then(jsonData => {


      // filter data to only take the 3 most recent measurements from each location
      let groupedData = _.groupBy(jsonData, 'Site Name');
      groupedData = _.map(groupedData, (h2sArray) => {
        return _.orderBy(h2sArray, ['Date with time'], ['desc']).slice(0, 3); // desc descending
      });
      console.log("Grouped Data: ", groupedData);

      // clear old data and build new table
      const jsonDiv = document.querySelector('#h2s_summary tbody');
      jsonDiv.innerHTML = "";

      // Convert JSON data to a formatted string for display
      groupedData.forEach((location) => {
        location.forEach((h2s) => {
          const rowElm = document.createElement("tr");
          rowElm.classList.add("card-data");
          const valueCell = document.createElement("td");
          const dateCell = document.createElement("td");
          const locationCell = document.createElement("td");
          rowElm.appendChild(valueCell);
          rowElm.appendChild(dateCell);
          rowElm.appendChild(locationCell);
          jsonDiv.appendChild(rowElm);

          // value
          const colorIndicatorElm = document.createElement("span");
          colorIndicatorElm.classList.add("indicator", getIndicatorLevelForH2SRating(h2s['level']));
          const result = document.createElement("span");
          result.innerText = h2s['Result'] + " ppb";
          valueCell.appendChild(colorIndicatorElm)
          valueCell.appendChild(result)

          // date
          const clockIcon = document.createElement("i");
          clockIcon.className = "bi bi-clock";
          const dateElm = document.createElement("span");
          let dateWithTime = dayjs(h2s['Date with time'])
          const tm = dateWithTime.format('dd h A')
          dateElm.innerText = tm
          dateCell.appendChild(clockIcon)
          dateCell.appendChild(dateElm)

          // location
          const locationIcon = document.createElement("i");
          locationIcon.className = "bi bi-geo-alt";
          const locationElm = document.createElement("span");
          locationElm.innerText = h2s['Site Name']
          locationCell.appendChild(locationIcon)
          locationCell.appendChild(locationElm)
        });
        const rowBreakElm = document.createElement("tr");
        rowBreakElm.classList.add("row-break");
        jsonDiv.appendChild(rowBreakElm);
      });

      // update card footer
      const cardFooter = document.querySelector("#h2s-card .card-footer");
      if (cardFooter) {
        const span = cardFooter.querySelector("span");
        const link = cardFooter.querySelector("a");
        const humanReadableDate = dayjs(jsonData[jsonData.length-1]['Date with time']).format('h:mm A, MMMM D');
        span.innerText = "Updated " + humanReadableDate;
      }
    })
    .catch(error => {
      console.error('Error fetching the JSON:', error);
    });


  /***** Odor Complaints Data *****/
  fetch(`${resilientUrlBase}tijuana/sd_complaints/output/complaints_by_date.json`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.statusText);
      }
      return response.json();
    })
    .then(jsonData => {
      console.log("Odor Complaints Data: ", jsonData);




      const now = new Date();
      // Calculate boundaries for the last 7 and 30 days
      const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

      // Filter for items in the last 7 days
      let last7DaysData = _.filter(jsonData,item => {
        let itemDate = parseCustomDate(item.date);
        return itemDate >= sevenDaysAgo && itemDate <= now;
      })
      last7DaysData = _.orderBy(last7DaysData, [item => parseCustomDate(item.date)], ['desc']);
      // const last7DaysData = _.chain(jsonData).filter(item => {
      //   const itemDate = parseCustomDate(item.date);
      //   return itemDate >= sevenDaysAgo && itemDate <= now;
      // }).value();

      // Filter for items in the 7 days before that
      let previous7DaysData = _.filter(jsonData, item => {
        let itemDate = parseCustomDate(item.date);
        return itemDate >= thirtyDaysAgo && itemDate < sevenDaysAgo;
      })
      previous7DaysData = _.orderBy(previous7DaysData, [item => parseCustomDate(item.date)], ['desc']);

      // Filter for items in the last 30 days
      let last30DaysData = _.filter(jsonData, item => {
        let itemDate = parseCustomDate(item.date);
        return itemDate >= thirtyDaysAgo && itemDate <= now;
      })
      last30DaysData=_.orderBy(last30DaysData, [item => parseCustomDate(item.date)], ['desc']);

      // Sum the count fields for each filtered array
      const sumLast7Days = _.sumBy(last7DaysData, 'count');
      const sumPrevious7Days = _.sumBy(previous7DaysData, 'count');
      const sumLast30Days = _.sumBy(last30DaysData, 'count');
      const sumAllDays = _.sumBy(jsonData, 'count');


      // update high level text
      const countSpan = document.getElementById('odor-complaint-count');
      console.log("Odor Complaints Count span", countSpan);
      const countIndicator = countSpan.parentElement.querySelector(".indicator");
      console.log("Odor Complaints Count indicator", countIndicator);
      countSpan.innerText = sumLast7Days + " Complaints";
      // FIXME: these numbers are arbitrary
      countIndicator.classList.remove("low", "intermediate", "moderate", "high");
      countIndicator.classList.add(getIndicatorLevelForOdorComplaints(sumLast7Days, 7));

      console.log("Update Odor Complaints Count: ", sumLast7Days);

      const countComplaintsChange = sumLast7Days - sumPrevious7Days;
      console.log("Odor Complaints Change: ", countComplaintsChange);
      const changeContainer = document.querySelector("#odor-complaint-data-overview tr td:last-child");
      const changeSpan = changeContainer.querySelector("span");
      const changeIcon = changeContainer.querySelector("i");
      changeSpan.innerText = `${(countComplaintsChange > 0 ? "+":"")} ${countComplaintsChange} from last week`;
      if (countComplaintsChange > 0) {
        changeIcon.classList.remove("trend-up", "trend-down", "trend-flat", "bi-graph-up-arrow", "bi-graph-down-arrow");
        changeSpan.classList.remove("trend-up", "trend-down", "trend-flat");
        changeIcon.classList.add("trend-down", "bi-graph-up-arrow");
        changeSpan.classList.add("trend-down");
      }
      else if (countComplaintsChange < 0) {
        changeIcon.classList.remove("trend-up", "trend-down", "trend-flat", "bi-graph-up-arrow", "bi-graph-down-arrow");
        changeSpan.classList.remove("trend-up", "trend-down", "trend-flat");
        changeIcon.classList.add("trend-up", "bi-graph-down-arrow");
        changeSpan.classList.add("trend-up");
      }
      else {
        changeIcon.classList.remove("trend-up", "trend-down", "trend-flat", "bi-graph-up-arrow", "bi-graph-down-arrow");
        changeSpan.classList.remove("trend-up", "trend-down", "trend-flat");
        changeIcon.classList.add("bi bi-graph-up-arrow");
        changeSpan.classList.add("trend-flat");
      }

      // clear old data and build new table
      const jsonDiv = document.querySelector('#odor-complaint-data tbody');
      jsonDiv.innerHTML = "";

      // Convert JSON data to a formatted string for display
      last7DaysData.forEach(
        obj => {
          const rowElm = document.createElement("tr");
          rowElm.classList.add("card-data");
          const dateCell = document.createElement("td");
          const countCell = document.createElement("td");
          rowElm.appendChild(dateCell);
          rowElm.appendChild(countCell);
          jsonDiv.appendChild(rowElm);

          // date
          const dateIcon = document.createElement("i");
          dateIcon.className = "bi bi-clock";
          const dateElm = document.createElement("span");
          let date = dayjs(obj['date'])
          const dateString = date.format("DD MMM YYYY");
          dateElm.innerText = dateString;
          dateCell.appendChild(dateIcon)
          dateCell.appendChild(dateElm)

          // count
          const countIndicatorElm = document.createElement("span");
          const countSpan = document.createElement("span");
          countIndicatorElm.classList.add("indicator", getIndicatorLevelForOdorComplaints(obj['count']));
          countSpan.innerText = obj['count'] + " complaints";
          countCell.appendChild(countIndicatorElm)
          countCell.appendChild(countSpan)
      });

      // update card footer
      const cardFooter = document.querySelector("#odor-complaints-card .card-footer");
      if (cardFooter) {
        const span = cardFooter.querySelector("span");
        const link = cardFooter.querySelector("a");
        const humanReadableDate = dayjs(jsonData[0]['date']).format('h:mm A, MMMM D');
        span.innerText = "Updated " + humanReadableDate;
      }
    })
    .catch(error => {
      console.error('Error fetching the JSON:', error);
    });


  /***** Beach Closures Data *****/
  fetch(`${resilientUrlBase}tijuana/beachwatch/output/beachwatch_closure_simple.json`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.statusText);
      }
      return response.json();
    })
    .then(jsonData => {
      // update high level text
      const countSpan = document.getElementById('beach-closure-count')
      const countIndicator = countSpan.parentElement.querySelector(".indicator");
      const countClosures = jsonData.length
      countSpan.innerText = countClosures + " Beaches Closed"
      // TODO: set the indicator color based on the count
      countIndicator.classList.remove("low", "intermediate", "moderate", "high");
      countIndicator.classList.add(getIndicatorLevelForBeachClosures(countClosures));

      const countClosuresChange = 0; // TODO: calculate the change from last week
      const changeContainer = document.querySelector("#beach-closure-data-overview tr td:last-child");
      const changeSpan = changeContainer.querySelector("span");
      const changeIcon = changeContainer.querySelector("i");
      changeSpan.innerText = `${(countClosuresChange > 0 ? "+":"")} ${countClosuresChange} from last week`;
      if (countClosuresChange > 0) {
        changeIcon.classList.remove("trend-up", "trend-down", "trend-flat", "bi-graph-up-arrow", "bi-graph-down-arrow");
        changeSpan.classList.remove("trend-up", "trend-down", "trend-flat");
        changeIcon.classList.add("trend-down", "bi-graph-up-arrow");
        changeSpan.classList.add("trend-down");
      }
      else if (countClosuresChange < 0) {
        changeIcon.classList.remove("trend-up", "trend-down", "trend-flat", "bi-graph-up-arrow", "bi-graph-down-arrow");
        changeSpan.classList.remove("trend-up", "trend-down", "trend-flat");
        changeIcon.classList.add("trend-up", "bi-graph-down-arrow");
        changeSpan.classList.add("trend-up");
      }
      else {
        changeIcon.classList.remove("trend-up", "trend-down", "trend-flat", "bi-graph-up-arrow", "bi-graph-down-arrow");
        changeSpan.classList.remove("trend-up", "trend-down", "trend-flat");
        changeSpan.classList.add("trend-flat");
        changeSpan.innerText = "same as last week";
      }

      // clear old data and build new table
      const jsonDiv = document.querySelector('#beach-closure-data tbody');
      jsonDiv.innerHTML = "";

      // Convert JSON data to a formatted string for display
      jsonData.forEach(
        obj => {
          /*
          obj = {
            Active: true
            DehID: "IB-060"
            Icon: "place"
            Latitude: 32.585678574
            Longitude: -117.133049366
            Name: "Carnation Avenue - Imperial Beach (IB-060)"
            RBGColor: "Red"
            SiteID: 9
          }
          */
          const name = obj['Name'];
          const humanReadableName = name.replace(/\([A-Z]{2}\-[0-9]+\)/g, "").split(" - ")[0].trim();

          const rowElm = document.createElement("tr");
          const beachNameCell = document.createElement("td");
          const beachStatusCell = document.createElement("td");
          rowElm.appendChild(beachNameCell);
          rowElm.appendChild(beachStatusCell);
          jsonDiv.appendChild(rowElm);

          // beach name
          const locationIcon = document.createElement("i");
          locationIcon.className = "bi bi-geo-alt";
          const beachNameElm = document.createElement("span");
          beachNameElm.innerText = humanReadableName;
          beachNameCell.appendChild(locationIcon);
          beachNameCell.appendChild(beachNameElm);

          // beach status
          const statusIcon = document.createElement("span");
          statusIcon.className = "indicator moderate";
          const beachStatusElm = document.createElement("span");
          beachStatusElm.innerText = "closed";
          beachStatusCell.appendChild(statusIcon);
          beachStatusCell.appendChild(beachStatusElm);
        });

      // update card footer
      const cardFooter = document.querySelector("#beach-closures-card .card-footer");
      if (cardFooter) {
        const span = cardFooter.querySelector("span");
        const link = cardFooter.querySelector("a");
        const humanReadableDate = dayjs(jsonData[0]['Date']).format('h:mm A, MMMM D');
        span.innerText = "Updated " + humanReadableDate;
      }
    })
    .catch(error => {
      console.error('Error fetching the JSON:', error);
    });


    /**
     * .indicator elements are colored based on a number.
     * @param {number} count - the number of odor complaints
     * @param {number} [accumulatedOverDays=1] - the number of days over which the count is accumulated
     * @returns {string} - the color class name corresponding to that number of odor complaints
     */
    function getIndicatorLevelForOdorComplaints(count, accumulatedOverDays=1) {
      // FIXME: Tommy just made up these numbers
      if (count < 3 * accumulatedOverDays) {
        return "low";
      }
      else if (count < 7 * accumulatedOverDays) {
        return "moderate";
      }
      else {
        return "high";
      }
    }

    /**
     * .indicator elements are colored based on a number.
     * @param {number} count - the number of beach closures
     * @returns {string} - the color class name corresponding to that number of beach closures
     */
    function getIndicatorLevelForBeachClosures(count) {
      if (count < 5) {
        return "low";
      }
      else if (count < 10) {
        return "moderate";
      }
      else {
        return "high";
      }
    }

    function getIndicatorLevelForH2SRating(rating) {
      switch (rating) {
        case 'orange':
          return "orange";
        case 'yellow':
          return "yellow";
        case 'green':
          return "green";
        case 'purple':
          return "purple";
        default:
          return "white";
      }
    }

    </script>
</body>
</html>
