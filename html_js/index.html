<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Environmental Dashboard</title>
  <link rel="stylesheet" href="./css/index.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <!-- jquery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    
    /* this will be the description for a beach about it's sampling */
    .beach-description  {
      display: none;

    }
    /* this will be the description for a beach about it's closure or advisory */
    .beach-message  {
      display: none;

    }
    /* this border for the table */
    table.odor-table {
      border-collapse: collapse;
    }
    table.odor-table td,  table.odor-table th {
      border: 1px solid black;
    }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <!--  <script type="module" src="js/fsmap.js"></script>-->
  <script type="module">
    const fs = "fsq3CYDP77ybwoo1KtkJigGRj6g0uYyhWVw25jM+zN6ovbI="
    const mapuid = '6ce3b305-7e09-44b3-8725-34dcf59bb56d'
    //   import {createMap} from 'https://corsproxy.io/?key=3d648870&url=https://cdn.jsdelivr.net/npm/@foursquare/map-sdk@latest/dist/index.js';
    import {createMap} from 'https://cdn.jsdelivr.net/npm/@foursquare/map-sdk@latest/dist/index.js';

    const map = await createMap({
      apiKey: fs,
      container: document.getElementById('map-container'),
      // this loads a published map
      // (original url: https://studio.foursquare.com/public/806b95d0-36bb-402c-b16c-24e54af4a761)
      initialState: {
        publishedMapId: mapuid
      },
      uiConfig:
        {
          sidePanel: {
            view: 'hidden'| 'collapsed' | 'visible',
            isAddLayerVisible: false,

          },
          sideNav:
            {isVisible: false}
        }


    });
    // cannot override style sheet. #shadow-root is closed.
    // var sheet = new CSSStyleSheet
    // sheet.replaceSync( `.unfolded-root + div + div  {visibility: collapse;}`)
    // map.shadowRoot.adoptedStyleSheets.push(sheet) // You want to add to stylesheets list
    globalThis.map = map

  </script>


  <script>
    //     <button onclick="toggleLayer(this, 'Beach Closures')">Beach Closures</button>

    // Toggle Sidebar Function
    const layerInfo = [
      {label: 'H₂S Levels', id: 'g0nrfjd'}, // health layer for now
      {label: 'Smell Complaints', id: '49rpvvq'}, // odor
      {label: 'Wastewater Spills', id: 'hg4pxs'}, // water
      {label: 'Beach Closures', id: 'dpoomlg'}, // observations
      {label: 'River Basin', id: '6n6ymt9'},

    ]

    // Toggle Expand Function for Cards
    function toggleExpand(ev) {
      let section = ev.target;
      while (!section.classList.contains("expandable")) {
        section = section.parentElement;
      }
      section.classList.toggle("expanded");
    }

    // Toggle Layer Function for Top Pills
    function toggleLayer(button, layer) {
      if (undefined !== map) {


        button.classList.toggle("active");
        console.log("Toggled layer:", layer);
        const layerid = layerInfo.find((l) => l.label == layer)
        console.log("Toggled layer:" + layer + " layerid:", layerid);
        const groups = map.getLayerGroups();
        console.log("Toggled layer: groups", groups);
        let targetLayer = groups.find((g) => g.id == layerid.id)
        console.log("Target layer:", targetLayer);
        if (targetLayer.isVisible) {
          targetLayer.isVisible = false;

        } else {
          targetLayer.isVisible = true;

        }
        map.updateLayerGroup(targetLayer.id, targetLayer)
      } else {
        console.log("toggleLayer: no map object: ", layer);
      }

    }

    // When a card is clicked, select the corresponding pill
    function selectCard(layer) {
      var buttons = document.querySelectorAll("#top-bar button");
      buttons.forEach(function (btn) {
        btn.classList.remove("active");
        if (btn.textContent.trim().toLowerCase() === layer.toLowerCase()) {
          btn.classList.add("active");
        }
      });
      console.log("Selected card for layer:", layer);
    }

    // Dummy play function for time widget
    function playTime(layer, sliderElem) {
      console.log("Playing time for " + layer + ", current value: " + sliderElem.value);
      // Implement fsmap updates based on time here.
    }
  </script>

  <script src="./js/sidebar.js"></script>
</head>
<body class="light">
<div id="container">
  <!-- Map Container with Kepler fsmap configured for San Ysidro (approx 50-mile radius) -->
  <div id="map-container"></div>
<!--  <div id="hidepanel">-->
<!--  </div>-->
  <!-- Top Pill Container -->
  <div id="top-bar-container">
    <div id="top-bar">
      <button class="active" onclick="toggleLayer(this, 'Beach Closures')">Beach Closures</button>
      <button class="active" onclick="toggleLayer(this, 'H₂S Levels')">H₂S Levels</button>
      <button class="active" onclick="toggleLayer(this, 'Smell Complaints')">Smell Complaints</button>
      <button class="active" onclick="toggleLayer(this, 'Wastewater Spills')">Wastewater Spills</button>
      <button onclick="toggleLayer(this, 'River Basin')">River Basin</button>
    </div>
  </div>

  <!-- Sidebar / Drawer -->
  <div id="sidebar-container">
    <!-- Floating button to open/close in desktop -->
    <button id="sidebar-btn" class="open" onclick="toggleSidebar()"><i class="bi bi-chevron-left"></i></button>

    <div id="sidebar" class="open">
      <div id="sidebar-handle"><div class="grip"></div></div>
      <div id="sidebar-header">
        <div><a href="https://www.sandiegocounty.gov/" target="_blank"><img src="img/logoCOSD.png"></a></div> 
        <div id="sidebar-title"><span>South Bay Region Dashboard</span></div>
        <div><a href="https://www.sandiegocounty.gov/" target="_blank"><img src="img/ResilientLogo.png"></a></div>
      </div>
      
      <div id="sidebar-body">
        <div class="sidebar-card-separator"><span><h2>Ongoing Events</h2></span></div>

        <!-- Card: What We Know (No time widget here) -->
        <div class="card shadow expandable expanded" onclick="selectCard('What We Know')">
          <div class="card-header">
            <i class="bi bi-info-circle"></i>
            <h3 class="card-title">What We Know</h3>
            <button class="expand-btn" onclick="event.stopPropagation(); toggleExpand(event)"><i class="bi bi-chevron-down"></i></button>
          </div>

          <p>A combination of several factors has led to the overflow of sewage, causing runoff water and contamination to go into the ocean on both the Mexico and U.S. sides.</p>
          <div id="know-info" class="expandable">
            <p>There are multi-agency efforts to address air and water quality issues in the Tijuana River Valley that are impacting San Diego area communities.
              <a target="_blank" href="https://www.sandiegocounty.gov/content/sdc/hhsa/programs/phs/community_epidemiology/south-region-health-concerns/County-Role.html">Learn more</a>
            </p>
            <p>This dashboard and mapping tool provides information from multiple sources about the air and water quality in San Diego.</p>
          </div>
          
          <div class="card-footer">
            <span></span>
          </div>
        </div>

        <!-- Text Card: What You Can Do -->
        <div class="card text-card shadow expandable expanded" class="expandable">
          <div class="card-header">
            <i class="bi bi-person"></i>
            <h3 class="card-title">What You Can Do</h3>
            <button class="expand-btn" onclick="event.stopPropagation(); toggleExpand(event)"><i class="bi bi-chevron-down"></i></button>
          </div>

          <div>
            <p>Report unusual conditions (like odors) to local authorities and share you observations with your community.</p>
          </div>
          <div id="you-can-do" class="card-data" style="display: none">
            Report odor complaints to the San Diego County Air Pollution Control District by:
            <ul>
              <li>Mobile app</li>
              <li>Phone at (858) 586-2650,</li>
              <li>Email to <a href="mailto:apcdcomp@sdapcd.org">apcdcomp@sdapcd.org,</a> or</li>
              <li>Visit <a href="http://www.sdapcd.org/content/sdapcd/compliance/air-quality-complaints.html">online.</a> </li>
            </ul>
          </div>

          <div class="card-footer">
            <span></span>
          </div>
        </div>

        <!-- Text Card: What We Don't Know -->
        <!-- <div class="card text-card shadow expandable">
          <div class="card-header">
            <i class="bi bi-person-walking"></i>
            <span class="card-question-circle">What We Don't Know</span>
            <button class="expand-btn" onclick="event.stopPropagation(); toggleExpand(event)"><i class="bi bi-chevron-down"></i></button>
          </div>

          <p>For details on the County's response to the sewage crisis and how to protect your health,
            visit our page about <a target="_blank" 
              href="https://www.sandiegocounty.gov/content/sdc/hhsa/programs/phs/community_epidemiology/south-region-health-concerns/County-Role.html">
              South Region Health Concerns </a>
            </p>
          <div id="doing-info" class="expandable">
            <div class="text-card">
              <h4> For more details about specific datasets, visit:</h4>
              <ul>
                <li><a target="_blank" href="https://sdbeachinfo.com/">San Diego Beach & Bay Water Quality Program</a></li>
                <li> <a target="_blank" href="https://www.sdapcd.org/">San Diego Air Pollution Control District</a></li>
                <li><a target="_blank" href="https://www.sandiegocounty.gov/content/sdc/hhsa/programs/phs/community_epidemiology/south-region-health-concerns/Local-Data.html">South Region Health Concerns Public Health Data</a>
                </li>
              </ul>
            </div>
          </div>
        </div> -->

        <!-- Text Card: What We’re Doing -->
        <div class="card text-card shadow expandable expanded">
          <div class="card-header">
            <i class="bi bi-person-walking"></i>
            <h3 class="card-title">What We're Doing</h3>
            <button class="expand-btn" onclick="event.stopPropagation(); toggleExpand(event)"><i class="bi bi-chevron-down"></i></button>
          </div>

          <p>For details on the County's response to the sewage crisis and how to protect your health,
            visit our page about <a target="_blank" 
              href="https://www.sandiegocounty.gov/content/sdc/hhsa/programs/phs/community_epidemiology/south-region-health-concerns/County-Role.html">
              South Region Health Concerns </a>
            </p>
          <div id="doing-info" class="expandable expanded">
            <div class="text-card">
              <h4> For more details about specific datasets, visit:</h4>
              <ul>
                <li><a target="_blank" href="https://sdbeachinfo.com/">San Diego Beach & Bay Water Quality Program</a></li>
                <li> <a target="_blank" href="https://www.sdapcd.org/">San Diego Air Pollution Control District</a></li>
                <li><a target="_blank" href="https://www.sandiegocounty.gov/content/sdc/hhsa/programs/phs/community_epidemiology/south-region-health-concerns/Local-Data.html">South Region Health Concerns Public Health Data</a>
                </li>
              </ul>
            </div>
          </div>

          <div class="card-footer">
            <span></span>
          </div>
        </div>

        <!-- Card: Air Quality (with time widget inside expandable section) -->
        <!--    <div class="card shadow expandable expanded" onclick="selectCard('Air Quality')">-->
        <!--      <div class="card-header">-->
        <!--        <h3 class="card-title">Air Quality</h3>-->
        <!--        <button class="expand-btn" onclick="event.stopPropagation(); toggleExpand(event)">⌄</button>-->
        <!--      </div>-->
        <!--      <div class="card-data">-->
        <!--        <span class="indicator moderate"></span>-->
        <!--        <span>AQI: 42</span>-->
        <!--        <span class="trend-up">▲ +3%</span>-->
        <!--      </div>-->
        <!--      <div id="aq-info" class="expandable">-->
        <!--        <p>Urban emissions contribute to moderate air quality. Pollutant levels are rising.</p>-->
        <!--        <a target="_blank" href="#">Check full AQI report</a>-->
        <!--        <div class="time-widget">-->
        <!--          <span class="time-title">Time Range:</span>-->
        <!--          <input type="range" min="2000" max="2025" value="2010" class="time-slider">-->
        <!--          <button class="time-play" onclick="playTime('Air Quality', this.previousElementSibling)">Play</button>-->
        <!--        </div>-->
        <!--      </div>-->
        <!--    </div>-->

        <div class="sidebar-card-separator"><span><h2>Reports</h2></span></div>

        <!-- Card: Hydrogen Sulfide Levels (with time widget inside expandable section) -->
        <div class="card shadow expandable expanded" onclick="selectCard('H₂S Levels')">
          <div class="card-header">
            <i class="bi bi-wind"></i>
            <h3 class="card-title">Hydrogen Sulfide</h3>
            <button class="expand-btn" onclick="event.stopPropagation(); toggleExpand(event)"><i class="bi bi-chevron-down"></i></button>
          </div>

          <p>
            Hydrogen Sulfide is currently mediocre. Limit outdoor activity today. If you have a known respiratory sensitivity, consider wearing a mask or bringing other protection with you today. 
            <br><br>
            Elevated H₂S detected near the border with variable readings among stations.
            <br>
            <li><a href="https://app.powerbigov.us/view?r=eyJrIjoiOGMwYzM2ZGYtZGU4Ny00ZGI5LWE2NWMtMmZlOGEzZTYzMDc3IiwidCI6IjQ1NjNhZjEzLWMwMjktNDFiMy1iNzRjLTk2NWU4ZWVjOGY5NiJ9" target="_blank">See real time monitoring</a></li>
          </p>

          <div id="h2s_summary">
            <div class="card-data">
              <span class="indicator moderate"></span>
              <span>7.4 ppm (Imperial Beach)</span>
              <span class="trend-down">▼ -0.2 ppm</span>
            </div>
            <div class="card-data">
              <span class="indicator moderate"></span>
              <span>12.5 ppm (Nestor)</span>
              <span class="trend-down">▼ -0.2 ppm</span>
            </div>
            <div class="card-data">
              <span class="indicator low"></span>
              <span>NA (San Ysidro)</span>
              <span class="trend-down">▼ -0.2 ppm</span>
            </div>
          </div>

          <div id="hs-info" class="expandable expanded">
            <p>Elevated H₂S detected near the border with variable readings among stations.</p>
            <a target="_blank"
              href="https://app.powerbigov.us/view?r=eyJrIjoiOGMwYzM2ZGYtZGU4Ny00ZGI5LWE2NWMtMmZlOGEzZTYzMDc3IiwidCI6IjQ1NjNhZjEzLWMwMjktNDFiMy1iNzRjLTk2NWU4ZWVjOGY5NiJ9">See
              real-time monitoring</a>
    <!--        <div class="time-widget">-->
    <!--          <span class="time-title">Time Range:</span>-->
    <!--          <input type="range" min="2000" max="2025" value="2010" class="time-slider">-->
    <!--          <button class="time-play" onclick="playTime('H₂S Levels', this.previousElementSibling)">Play</button>-->
    <!--        </div>-->
          </div>
          <p>Dataset Information: <a target="_blank" href="https://www.sdapcd.org/">San Diego Air Pollution Control District</a></p>

          <div class="card-footer">
            <span></span>
          </div>
        </div>

        <!-- Card: Beach Closures (with time widget inside expandable section) -->
        <div class="card shadow expandable expanded" onclick="selectCard('Beach Closures')">
          <div class="card-header">
            <i class="bi bi-water"></i>
            <h3 class="card-title">Beach Closures</h3>
            <button class="expand-btn" onclick="event.stopPropagation(); toggleExpand(event)"><i class="bi bi-chevron-down"></i></button>
          </div>

          <div class="card-data">
            <span class="indicator high"></span>
            <span id="beach-closure-count">11 Beaches Closed</span>
            <span class="trend-up">▲ +1</span>
          </div>
          <div id="beach-info" class="expandable expanded">
            <p>Bacteria levels along parts of the Tijuana River have led to closures.</p>
            <a target="_blank" href="#">View closure fsmap</a>
    <!--        <div class="time-widget">-->
    <!--          <span class="time-title">Time Range:</span>-->
    <!--          <input type="range" min="2000" max="2025" value="2010" class="time-slider">-->
    <!--          <button class="time-play" onclick="playTime('Beach Closures', this.previousElementSibling)">Play</button>-->
    <!--        </div>-->
            <div class="text-card">
              <h3>About Water Quality Issues</h3>
              <p>Check online to find out which beaches are closed, have health advisories, or are being monitored for water
                quality. This is especially important after heavy rain
                Stay away from areas with visible sewage spills
                Stay out of floodwater
                Do not swim, go into, or swallow contaminated water sources
                .</p>
            </div>
          </div>

          <div class="card-footer">
            <span></span>
          </div>
        </div>

        <!-- Card: Public Odor Complaints (with time widget inside expandable section) -->
        <div class="card shadow expandable expanded" onclick="selectCard('Odor Complaints')">
          <div class="card-header">
            <i class="bi bi-exclamation-circle"></i>
            <h3 class="card-title">Public Odor Complaints</h3>
            <button class="expand-btn" onclick="event.stopPropagation(); toggleExpand(event)"><i class="bi bi-chevron-down"></i></button>
          </div>
          
          <div class="card-data card shadow">
    <!--        <span class="indicator moderate"></span>-->'
            <div> Odor Complaints</div>
            <table class="odor-table">
              <tr>
                <td>7 Days</td>
                <td>30 Days</td>
                <td>Since 2023</td>
              </tr>
              <tr>
                <td id="odor-count-7">Row 2, Column 1</td>
                <td id="odor-count-30">Row 2, Column 2</td>
                <td id="odor-count">Row 2, Column 3</td>
              </tr>
            </table>
    <!--        <span id="odor-trend" class="trend-up">▲ +2</span>-->
          </div>

          <div id="odor-info" class="card shadow expandable expanded">
            <p> The data for this layer is from public input <a target="_blank" href="https://gis-portal.sandiegocounty.gov/arcgis/apps/dashboards/f1f548c93c1b44eeb289b4daa0bec5df">SD County Odor Complaints Dashboard</a> </p>
            <li><a target="_blank" href="https://www.sandiegocounty.gov/content/sdc/hhsa/programs/phs/community_epidemiology/south-region-health-concerns/Local-Data.html">South Region Health Concerns Public Health Data</a>

            <div class="text-card">
              <h3>About Air Quality</h3>
              <p>Reduce your exposure to poor quality air or strong odors by limiting outdoor activity, keeping windows and
                doors closed, and airing out your home or business when odors are not present
                If available, use air conditioning or portable indoor air purifiers. Look into whether filters need to be
                replaced
                Use certified HEPA filters with activated charcoal
                If possible, run your air conditioner at your business for 1-2 hours before opening”
              </p>
            </div>
                <!--        <ul>-->
                <!--          <li><strong>Downtown:</strong> Strong rotten egg odor (Industrial)</li>-->
                <!--          <li><strong>Ocean Beach:</strong> Faint sewage odor (Sewage)</li>-->
                <!--          <li><strong>Little Italy:</strong> Chemical smell (Chemical)</li>-->
                <!--        </ul>-->

                <a target="_blank" href="https://gis-portal.sandiegocounty.gov/arcgis/apps/dashboards/f1f548c93c1b44eeb289b4daa0bec5df">View SD County Odor Complaints Dashboard</a>
        <!--        <div class="time-widget">-->
        <!--          <span class="time-title">Time Range:</span>-->
        <!--          <input type="range" min="2000" max="2025" value="2010" class="time-slider">-->
        <!--          <button class="time-play" onclick="playTime('Odor Complaints', this.previousElementSibling)">Play</button>-->
        <!--        </div>-->
              <p> Dataset information: <a target="_blank" href="https://sdbeachinfo.com/">San Diego Beach & Bay Water Quality Program</a></p>
          </div>

          <div class="card-footer">
            <span></span>
          </div>
        </div>

        <div class="sidebar-card-separator"><span><h2>Health Concerns Report</h2></span></div>

        <!-- Gastrointestinal -->
        <div class="card text-card shadow expandable expanded">
          <div class="card-header">
            <i class="bi bi-sun"></i>
            <h3 class="card-title">Gastrointestinal</h3>
            <button class="expand-btn" onclick="event.stopPropagation(); toggleExpand(event)"><i class="bi bi-chevron-down"></i></button>
          </div>

          <p>
            Gastrointestinal symptoms are symptoms such as diarrhea and vomiting. Gastrointestinal symptoms emergency department visits in San Diego County and the South Region area has been gradually declining over the past three months with some short-term fluctuations. The South Region area consistently has fewer visits than the San Diego County.
            <br><br>
            See <a target="_blank" href="https://www.sandiegocounty.gov/content/dam/sdc/hhsa/programs/phs/Epidemiology/south-region-gi-illness/Surveillance%20Bulletin%20South%20Region%20Health%20Concerns_03122025.pdf">County Health Report</a> for more information
          </p>
          <div class="card-footer">
            <span></span>
          </div>
        </div>

        <!-- Asthma and COPD -->
        <div class="card text-card shadow expandable expanded">
          <div class="card-header">
            <i class="bi bi-sun"></i>
            <h3 class="card-title">Asthma and COPD</h3>
            <button class="expand-btn" onclick="event.stopPropagation(); toggleExpand(event)"><i class="bi bi-chevron-down"></i></button>
          </div>

          <p>
            Asthma or chronic obstructive pulmonary disease (COPD) symptoms are symptoms such as reactive airway disease, wheezing, and bronchospasm. Asthma and COPD symptoms emergency department visits in San Diego County and the South Region area showed an increasing trend through mid-February but is currently in a gradual decline. South Region visits are consistently lower than the overall San Diego county visits.
            <br><br>
            See <a target="_blank" href="https://www.sandiegocounty.gov/content/dam/sdc/hhsa/programs/phs/Epidemiology/south-region-gi-illness/Surveillance%20Bulletin%20South%20Region%20Health%20Concerns_03122025.pdf">County Health Report</a> for more information
          </p>
          <div class="card-footer">
            <span></span>
          </div>
        </div>


        <!-- South Region Health Concerns -->
        <div class="card text-card shadow expandable expanded">
          <div class="card-header">
            <i class="bi bi-graph-up-arrow"></i>
            <h3 class="card-title">South Region Health Concerns</h3>
            <button class="expand-btn" onclick="event.stopPropagation(); toggleExpand(event)"><i class="bi bi-chevron-down"></i></button>
          </div>

          <p>
            TODO:
          </p>
          <div class="card-footer">
            <span></span>
          </div>
        </div>

        <div class="sidebar-card-separator"><span><h2>---</h2></span></div>

        <!-- Text Card: For More Information -->
        <div class="text-card card shadow expandable expanded">
          <div class="card-header">
            <i class="bi bi-info-circle"></i>
            <h3 class="card-title">For More Information</h3>
            <button class="expand-btn" onclick="event.stopPropagation(); toggleExpand(event)"><i class="bi bi-chevron-down"></i></button>
          </div>

          <div class="text-card">
            For details on the County’s response to the sewage crisis and how to protect your health, visit the      <a target="_blank" href="https://www.sandiegocounty.gov/content/sdc/hhsa/programs/phs/community_epidemiology/south-region-health-concerns.html">Visit South Region Health Concerns webpage</a>
          </div>

          <div class="text-card">
            <h4>Contact & Feedback </h4>
            <div>For questions or to provide feedback,</div> please <a target="_blank" href="mailto:phs.southregionhealth.hhsa@sdcounty.ca.gov"
            >email the Epidemiology Unit</a>
          </div>


          <div class="text-card">
            <h4> For more details about specific datasets, visit:</h4>
            <ul>
              <li><a target="_blank" href="https://sdbeachinfo.com/">San Diego Beach & Bay Water Quality Program</a></li>
              <li> <a target="_blank" href="https://www.sdapcd.org/">San Diego Air Pollution Control District</a></li>
              <li><a target="_blank" href="https://www.sandiegocounty.gov/content/sdc/hhsa/programs/phs/community_epidemiology/south-region-health-concerns/Local-Data.html">South Region Health Concerns Public Health Data</a>
              </li>
            </ul>
          </div>
        </div>

      </div> <!-- End of Sidebar Body -->
    </div> <!-- End of Sidebar -->
  </div> <!-- End of Sidebar Container -->
</div>

<script>
  function parseCustomDate(dateStr) {
    // Split the string into parts: [year, day, month]
    let [year,  month, day] = dateStr.split('-').map(Number);
    // Note: in JavaScript, months are 0-indexed (0 = January)
    return new Date(year, month - 1, day);
  }


  /***** Hydrogen Sulfide Data *****/
  fetch('https://oss.resilientservice.mooo.com/resilentpublic/tijuana/sd_apcd_air/output/warnings/h2s.json')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.statusText);
      }
      return response.json();
    })
    .then(jsonData => {
      const jsonDiv = document.getElementById('h2s_summary');
      const h2shead = document.createElement("div")
      h2shead.innerText = "Recent Events"
      jsonDiv.innerText = ''
      jsonDiv.appendChild(h2shead)

      // Convert JSON data to a formatted string for display
      jsonData.forEach(
        h2s => {
          const d = document.createElement("div");
          d.className = "card-data"
          const ind = document.createElement("span");
          switch (h2s['level']) {
            case 'orange':
              ind.className = "indicator orange"
              break;
            case 'yellow':
              ind.className = "indicator yellow"
              break;
            case 'green':
              ind.className = "indicator green"
              break;
            case 'purple':
              ind.className = "indicator purple"
              break;
            default:
              ind.className = "indicator white"
              break;
          }

          const result = document.createElement("span");
          result.innerText = h2s['Result']
          const date = document.createElement("span");
          //let dt = new Date(h2s['Date with time'])
          let dt = dayjs(h2s['Date with time'])
          //const day = dt.getDay()
          //const tm = dt.toLocaleTimeString("en-US")
          //const tm = dt.hour()
          const tm = dt.format('dddd  h A')
          date.innerText = tm
          const name = document.createElement("span");
          name.innerText = h2s['Site Name']
          d.appendChild(ind)
          d.appendChild(result)
          d.appendChild(date)
          d.appendChild(name)
          jsonDiv.appendChild(d)
        }
      )

      // update card footer
      const cardFooter = jsonDiv.parentElement.querySelector(".card-footer span");
      if (cardFooter) {
        const humanReadableDate = dayjs(jsonData[0]['Date with time']).format('h:mm A, MMMM D');
        cardFooter.innerText = "Updated " + humanReadableDate;
      }
    })
    .catch(error => {
      console.error('Error fetching the JSON:', error);
    });


  /***** Odor Complaints Data *****/
  fetch('https://oss.resilientservice.mooo.com/resilentpublic/tijuana/sd_complaints/output/complaints_by_date.json')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.statusText);
      }
      return response.json();
    })
    .then(jsonData => {
      const now = new Date();
      // Calculate boundaries for the last 7 and 30 days
      const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

      // Filter for items in the last 7 days
      let last7DaysData = _.filter(jsonData,item => {
        let itemDate = parseCustomDate(item.date);
        return itemDate >= sevenDaysAgo && itemDate <= now;
      })
      last7DaysData = _.orderBy(last7DaysData, [item => parseCustomDate(item.date)], ['desc']);
      // const last7DaysData = _.chain(jsonData).filter(item => {
      //   const itemDate = parseCustomDate(item.date);
      //   return itemDate >= sevenDaysAgo && itemDate <= now;
      // }).value();

      // Filter for items in the last 30 days
      let last30DaysData = _.filter(jsonData, item => {
        let itemDate = parseCustomDate(item.date);
        return itemDate >= thirtyDaysAgo && itemDate <= now;
      })
      last30DaysData=_.orderBy(last30DaysData, [item => parseCustomDate(item.date)], ['desc']);

      // Sum the count fields for each filtered array
      const sumLast7Days = _.sumBy(last7DaysData, 'count');
      const sumLast30Days = _.sumBy(last30DaysData, 'count');
      const countSpan = document.getElementById('odor-count');
      /* need to use lodash to parse and filter */
      const odorCount = _.sumBy(jsonData, 'count');
      countSpan.innerText =odorCount
      const countSpan_7 = document.getElementById('odor-count-7');
      /* need to use lodash to parse and filter */

      countSpan_7.innerText =sumLast7Days
      const countSpan_30 = document.getElementById('odor-count-30');
      /* need to use lodash to parse and filter */

      countSpan_30.innerText =sumLast30Days
      const jsonDiv = document.getElementById('odor-info');
      const h2shead = document.createElement("ul")
      h2shead.innerText = "Recent Complaints "
      jsonDiv.innerText = ''
      jsonDiv.appendChild(h2shead)

      // Convert JSON data to a formatted string for display
      last7DaysData.forEach(
        obj => {
          const d = document.createElement("li");
          d.className = "card-data"


          const dateSpan = document.createElement("span");
          dateSpan.innerText = obj['date']
          const countSpan = document.createElement("span");
          countSpan.innerText = obj['count']
          d.appendChild(dateSpan)
          d.appendChild(countSpan)

          jsonDiv.appendChild(d)
        })
      
      // update card footer
      const cardFooter = jsonDiv.parentElement.querySelector(".card-footer span");
      if (cardFooter) {
        const humanReadableDate = dayjs(jsonData[0]['date']).format('h:mm A, MMMM D');
        cardFooter.innerText = "Updated " + humanReadableDate;
      }
    })
    .catch(error => {
      console.error('Error fetching the JSON:', error);
    });


  /***** Beach Closures Data *****/
  fetch('https://oss.resilientservice.mooo.com/resilentpublic/tijuana/beachwatch/output/beachwatch_closure_simple.json')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.statusText);
      }
      return response.json();
    })
    .then(jsonData => {
      const countSpan= document.getElementById('beach-closure-count')
      const countClosures = jsonData.length
      countSpan.innerText = countClosures + " Beaches Closed"
      const jsonDiv = document.getElementById('beach-info');
      const h2shead = document.createElement("ul")
      h2shead.innerText = "Recent Closures"
      jsonDiv.innerText = ''
      jsonDiv.appendChild(h2shead)

      // Convert JSON data to a formatted string for display
      jsonData.forEach(
        obj => {
          const d = document.createElement("li");
          d.className = "card-data"


          const result = document.createElement("span");
          result.innerText = obj['Name']
          /* link for description */
          const descLink = document.createElement("span");
          descLink.innerText = 'Description'
          /* content for modal popup for description */
          const desc = document.createElement("div");
          desc.className = 'beach-message'
          desc.innerHTML= obj['Description']
          /* link for closure/advisory message */
          const mesgLink = document.createElement("span");
          mesgLink.innerText = 'Closure'
          /* content for modal popup for closure/advisory message */
          const mesg = document.createElement("div");
          mesg.className = 'beach-message'
          mesg.innerText = obj['Closure']

          d.appendChild(result)
          d.appendChild(descLink)
          d.appendChild(mesgLink)
          d.appendChild(desc)
          d.appendChild(mesg)
          jsonDiv.appendChild(d)
        });
      
      // update card footer
      const cardFooter = jsonDiv.parentElement.querySelector(".card-footer span");
      if (cardFooter) {
        const humanReadableDate = dayjs(jsonData[0]['Date']).format('h:mm A, MMMM D');
        cardFooter.innerText = "Updated " + humanReadableDate;
      }
    })
    .catch(error => {
      console.error('Error fetching the JSON:', error);
    });
    </script>
</body>
</html>
